<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOOU - Gestion Pro Mada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .view { display: none; }
        .view-active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 pb-28">

    <header class="p-5 flex justify-between items-center bg-white sticky top-0 z-50 border-b border-slate-100">
        <h1 class="text-2xl font-black text-indigo-600 italic">YOOU</h1>
        <button onclick="exportData()" class="text-[10px] font-black bg-slate-100 px-3 py-2 rounded-xl uppercase">Sauvegarde</button>
    </header>

    <div id="viewDashboard" class="view view-active p-4 max-w-2xl mx-auto">
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar">
            <button onclick="setFilter('En attente')" id="f1" class="px-6 py-2.5 rounded-full text-[10px] font-black uppercase">Ã€ faire</button>
            <button onclick="setFilter('Cousu')" id="f2" class="px-6 py-2.5 rounded-full text-[10px] font-black uppercase">Cousu</button>
            <button onclick="setFilter('LivrÃ©')" id="f3" class="px-6 py-2.5 rounded-full text-[10px] font-black uppercase">Archives</button>
        </div>
        <div id="orderList" class="space-y-4"></div>
    </div>

    <div id="viewAdd" class="view p-4 max-w-2xl mx-auto">
        <div class="bg-white rounded-[2.5rem] p-8 shadow-xl">
            <h2 id="formHeadline" class="text-2xl font-extrabold mb-8">Prise de commande</h2>
            <form id="orderForm" class="space-y-4">
                <input type="hidden" id="editId">
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-2 uppercase">Date de Prise (Mada)</label>
                        <input type="date" id="datePrise" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-none text-xs">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-2 uppercase">Livraison PrÃ©vue</label>
                        <input type="date" id="dateLivraison" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-none text-xs" required>
                    </div>
                </div>

                <input type="text" id="client" placeholder="Nom du client" class="w-full p-4 bg-slate-50 rounded-2xl outline-none" required>
                <input type="text" id="type" placeholder="Article" class="w-full p-4 bg-slate-50 rounded-2xl outline-none" required>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-green-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-bold text-green-500 uppercase">Avance (Ar)</label>
                        <input type="number" id="avance" value="0" class="w-full bg-transparent font-black outline-none">
                    </div>
                    <div class="bg-rose-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-bold text-rose-500 uppercase">Reste (Ar)</label>
                        <input type="number" id="reste" value="0" class="w-full bg-transparent font-black outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="coutMatos" placeholder="CoÃ»t Tissu" class="p-4 bg-slate-50 rounded-2xl outline-none text-xs">
                    <input type="number" id="coutMO" placeholder="CoÃ»t Main d'Å“uvre" class="p-4 bg-slate-50 rounded-2xl outline-none text-xs">
                </div>

                <button type="submit" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black text-xs uppercase tracking-widest shadow-xl">
                    Enregistrer la commande
                </button>
            </form>
        </div>
    </div>

    <div id="viewFinances" class="view p-4 max-w-2xl mx-auto">
        <h2 class="text-xl font-black mb-6">RentabilitÃ© ðŸ’°</h2>
        <div id="financeList" class="space-y-4"></div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-slate-100 p-5 flex justify-around items-center z-50">
        <button onclick="switchView('dashboard')" id="navDash" class="flex flex-col items-center gap-1 active-nav"><i class="bi bi-ui-checks-grid text-xl"></i><span class="text-[9px] font-black">SUIVI</span></button>
        <button onclick="switchView('finances')" id="navFin" class="flex flex-col items-center gap-1 text-slate-300"><i class="bi bi-wallet2 text-xl"></i><span class="text-[9px] font-black">COÃ›TS</span></button>
        <button onclick="openAddView()" id="navAdd" class="flex flex-col items-center gap-1 text-slate-300"><i class="bi bi-plus-circle-fill text-xl"></i><span class="text-[9px] font-black">NOUVEAU</span></button>
    </nav>

    <script>
        let orders = JSON.parse(localStorage.getItem('yoou_v2_db')) || [];
        let currentFilter = 'En attente';

        // Fonction pour obtenir la date actuelle au format Mada (Y-m-d)
        function getMadaDate() {
            return new Date().toLocaleDateString('en-CA', {timeZone: 'Indian/Antananarivo'});
        }

        function getDayCounter(creationDateStr) {
            const creation = new Date(creationDateStr);
            creation.setHours(0,0,0,0);
            const today = new Date();
            today.setHours(0,0,0,0);
            const diffTime = today - creation;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        function render() {
            const list = document.getElementById('orderList');
            const filtered = orders.filter(o => o.statut === currentFilter);

            document.querySelectorAll('[id^="f"]').forEach(btn => btn.className = "px-6 py-2.5 rounded-full text-[10px] font-black bg-white text-slate-300 border border-slate-100 uppercase");
            const activeTab = currentFilter === 'En attente' ? 'f1' : currentFilter === 'Cousu' ? 'f2' : 'f3';
            document.getElementById(activeTab).className = "px-6 py-2.5 rounded-full text-[10px] font-black bg-indigo-600 text-white shadow-lg uppercase";

            list.innerHTML = filtered.map(o => {
                const jCount = getDayCounter(o.timestamp);
                const isLate = jCount >= 5;
                return `
                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-50 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 px-4 py-2 ${isLate ? 'bg-rose-500' : 'bg-slate-800'} text-white text-[10px] font-black rounded-bl-2xl">
                        JOUR ${jCount}
                    </div>
                    <div class="mb-4" onclick="editOrder(${o.id})">
                        <h3 class="font-extrabold text-slate-800">${o.client}</h3>
                        <p class="text-[9px] font-black text-indigo-500 uppercase">Livrer le : ${new Date(o.dateLivraison).toLocaleDateString('fr-FR')}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="changeStatut(${o.id}, '${o.statut === 'En attente' ? 'Cousu' : 'LivrÃ©'}')" class="flex-grow py-3 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase">
                            ${o.statut === 'En attente' ? 'PrÃªt (Cousu) ðŸª¡' : 'Confirmer Livraison âœ…'}
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function openAddView() {
            document.getElementById('orderForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('datePrise').value = getMadaDate();
            switchView('add');
        }

        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const data = {
                id: editId ? Number(editId) : Date.now(),
                timestamp: document.getElementById('datePrise').value, // Date de prise modifiable
                client: document.getElementById('client').value,
                type: document.getElementById('type').value,
                dateLivraison: document.getElementById('dateLivraison').value,
                avance: Number(document.getElementById('avance').value),
                reste: Number(document.getElementById('reste').value),
                coutMatos: Number(document.getElementById('coutMatos').value),
                coutMO: Number(document.getElementById('coutMO').value),
                statut: editId ? orders.find(x=>x.id==editId).statut : 'En attente'
            };
            
            if(editId) {
                orders = orders.map(o => o.id == editId ? data : o);
            } else {
                orders.unshift(data);
            }
            
            localStorage.setItem('yoou_v2_db', JSON.stringify(orders));
            switchView('dashboard');
        });

        function changeStatut(id, n) {
            orders = orders.map(o => o.id === id ? {...o, statut: n, avance: (n==='LivrÃ©'? o.avance+o.reste : o.avance), reste: (n==='LivrÃ©'? 0 : o.reste)} : o);
            localStorage.setItem('yoou_v2_db', JSON.stringify(orders));
            render();
        }

        function editOrder(id) {
            const o = orders.find(x => x.id === id);
            document.getElementById('editId').value = o.id;
            document.getElementById('datePrise').value = o.timestamp.split('T')[0];
            document.getElementById('dateLivraison').value = o.dateLivraison;
            document.getElementById('client').value = o.client;
            document.getElementById('type').value = o.type;
            document.getElementById('avance').value = o.avance;
            document.getElementById('reste').value = o.reste;
            document.getElementById('coutMatos').value = o.coutMatos;
            document.getElementById('coutMO').value = o.coutMO;
            switchView('add');
        }

        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('view-active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('active-nav', 'text-slate-300'));
            document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('view-active');
            if(view === 'dashboard') render();
            if(view === 'finances') renderFinances();
        }

        function renderFinances() {
            const list = document.getElementById('financeList');
            list.innerHTML = orders.map(o => {
                const totalVente = o.avance + o.reste;
                const depenses = (o.coutMatos || 0) + (o.coutMO || 0);
                return `<div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div><p class="font-bold">${o.client}</p><p class="text-[10px] text-slate-400 uppercase">${o.type}</p></div>
                    <div class="text-right text-green-600 font-black text-xs">${(totalVente - depenses).toLocaleString()} Ar</div>
                </div>`;
            }).join('');
        }

        function setFilter(f) { currentFilter = f; render(); }
        render();
    </script>
</body>
</html>
